name: CI/CD

on:
  push:
    branches: [ main ]
  pull_request:

permissions:
  contents: write
  packages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: 'https://npm.pkg.github.com/'
          scope: '@eben4real'

      - name: Enable Corepack (Yarn)
        run: corepack enable

      - name: Install Dependencies
        run: yarn install --frozen-lockfile
        env:
          NODE_AUTH_TOKEN: ${{ secrets.TOKEN }}  # for GitHub Packages

      - name: Run Tests
        run: |
          if yarn run | grep -q "test"; then
            yarn test
          else
            echo "No test script found, skipping."
          fi

      # Build only apps/web (and its deps) via path filter
      - name: Build Web App (Turborepo)
        run: yarn turbo run build --filter=@eben4real/web...
        env:
          NODE_ENV: production

      # Fail fast if static export didn't happen
      - name: Assert build output exists
        run: |
          if [ ! -d "apps/web/out" ]; then
            echo "apps/web/out not found. The app did not export static files."
            echo "Tree of apps/web:"; ls -la apps/web || true
            exit 1
          fi
          echo "Found apps/web/out:"
          ls -la apps/web/out

      # Upload the exact folder the deploy job expects
      - name: Upload Web Build
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: apps/web/out
          if-no-files-found: error
          retention-days: 5

  publish:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: 'https://npm.pkg.github.com'
          scope: '@eben4real'

      - name: Install Dependencies
        run: yarn install --frozen-lockfile
        env:
          NODE_AUTH_TOKEN: ${{ secrets.TOKEN }}

      - name: Create Release PR or Publish
        uses: changesets/action@v1
        with:
          publish: yarn changeset publish
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.TOKEN }}

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://d2ej5qzyy7dju9.cloudfront.net  # use full URL for a clickable link
    steps:
      - name: Download Web Build
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: web-build

      # We uploaded apps/web/out directly, so the artifact root IS the output
      - name: Set output dir
        id: outdir
        run: echo "dir=web-build" >> $GITHUB_OUTPUT
      
      - name: Verify OIDC Token for AWS
        run: |
          # Get the raw OIDC token
          TOKEN=$(curl -s -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=sts.amazonaws.com" | jq -r '.value')
          
          echo "Token acquired successfully: ${#TOKEN} characters"
          
          # Decode and display the payload
          PAYLOAD=$(echo $TOKEN | cut -d'.' -f2)
          PADDING=$((${#PAYLOAD} % 4))
          if [ $PADDING -eq 2 ]; then PAYLOAD="$PAYLOAD=="; fi
          if [ $PADDING -eq 3 ]; then PAYLOAD="$PAYLOAD="; fi
          
          echo "Decoded payload:"
          echo $PAYLOAD | base64 -d | jq
        env:
          ACTIONS_ID_TOKEN_REQUEST_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ACTIONS_ID_TOKEN_REQUEST_URL: ${{ env.ACTIONS_ID_TOKEN_REQUEST_URL }}


      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-north-1

      - name: Sync assets to S3 (long cache)
        run: |
          aws s3 sync "${{ steps.outdir.outputs.dir }}/" "s3://${{ vars.S3_BUCKET }}/" \
            --delete \
            --exclude "index.html" \
            --cache-control "public, max-age=31536000, immutable"

      - name: Upload index.html (short cache)
        run: |
          aws s3 cp "${{ steps.outdir.outputs.dir }}/index.html" "s3://${{ vars.S3_BUCKET }}/index.html" \
            --cache-control "public, max-age=0, must-revalidate" \
            --content-type "text/html; charset=utf-8"

      - name: Invalidate CloudFront Cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id "${{ vars.CLOUDFRONT_DISTRIBUTION_ID }}" \
            --paths "/*"
